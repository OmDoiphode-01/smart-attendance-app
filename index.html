<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance System (Vision API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue-primary: #1e40af; /* Deeper blue */
            --blue-accent: #3b82f6; /* Lighter, vibrant blue */
            --blue-light: #eff6ff; /* Very light blue for backgrounds */
            --gray-text: #4b5563;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--blue-light);
            transition: all 0.3s ease-in-out;
        }
        
        .container {
            max-width: 1024px;
        }
        
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }

        /* New styles for the theme */
        .theme-background {
        background-image: url('https://www.shutterstock.com/image-vector/thin-line-membership-icon-like-600nw-2064487784.jpg');
        background-size: cover;
        background-position: center;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .theme-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .btn-primary {
            background-color: #1a1a1a;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #333;
        }

        .btn-secondary {
            background-color: white;
            color: #1a1a1a;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: 2px solid #1a1a1a;
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #f5f5f5;
        }

        .btn-link {
            color: var(--blue-primary);
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #f7f7f7;
        }
        .input-field:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 2px rgba(26, 26, 26, 0.1);
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        #attendance-photo-container {
            position: relative;
            max-width: 100%;
            height: auto;
        }
        #webcam-video, #attendance-image-preview, #uploaded-image-preview, .enrollment-webcam-video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #attendance-canvas {
            top: 0;
            left: 0;
        }
        .class-card {
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #93c5fd; /* Light blue border */
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }
        /* New styles for the pop-up status buffer */
        #status-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease-in-out;
        }
        #status-popup.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -40%);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #1a1a1a;
            animation: spin 1s ease infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hides the enroll student option from the navigation */
        #nav-class-enroll {
            display: none;
        }
    </style>
</head>
<body class="bg-blue-50 font-sans">

    <div id="status-popup" class="hidden">
        <div class="loading-spinner"></div>
        <p id="status-message" class="font-semibold text-gray-700"></p>
    </div>

    <div class="container mx-auto p-4 md:p-8">

        <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 mb-8 tracking-tight">Smart Attendance System</h1>
        
        <div id="student-enrollment-link-page" class="card hidden md:w-2/3 lg:w-1/2 mx-auto">
             <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Enroll in <span id="enrollment-class-name" class="text-blue-600"></span></h2>
             <form id="enroll-link-form">
                 <input type="hidden" id="enroll-link-class-code">
                 <div class="mb-4">
                     <label for="enroll-link-student-name" class="block text-gray-700 font-medium mb-2">Full Name</label>
                     <input type="text" id="enroll-link-student-name" required class="input-field">
                 </div>
                 <div class="mb-4">
                     <label for="enroll-link-roll-number" class="block text-gray-700 font-medium mb-2">Roll Number</label>
                     <input type="text" id="enroll-link-roll-number" required class="input-field">
                 </div>
                 <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Face Image</label>
                    <div class="flex space-x-2 mb-4">
                        <button type="button" id="enroll-link-webcam-tab-button" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Use Webcam</button>
                        <button type="button" id="enroll-link-upload-tab-button" class="flex-1 bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Upload Photo</button>
                    </div>
                    <div id="enroll-link-webcam-section">
                        <div id="enroll-link-webcam-container" class="relative">
                            <video id="enroll-link-webcam-video" autoplay muted playsinline class="enrollment-webcam-video hidden"></video>
                            <canvas id="enroll-link-webcam-canvas" class="hidden"></canvas>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button type="button" id="enroll-link-start-webcam-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Start Webcam</button>
                            <button type="button" id="enroll-link-switch-camera-button" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Switch Camera</button>
                            <button type="button" id="enroll-link-take-photo-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Take Photo</button>
                        </div>
                    </div>
                    <div id="enroll-link-upload-section" class="hidden">
                        <label for="enroll-link-image" class="block text-gray-700 font-medium mb-2">Upload Face Image</label>
                        <input type="file" id="enroll-link-image" accept="image/*" class="w-full text-gray-700">
                        <div id="enroll-link-image-preview-container" class="relative mt-4 hidden">
                            <img id="enroll-link-image-preview" src="#" alt="Image Preview" class="max-w-full h-auto rounded-lg shadow-md">
                        </div>
                    </div>
                 </div>
                 <button type="submit" class="mt-4 w-full btn-primary">
                     Enroll
                 </button>
                 <button type="button" id="back-to-main-from-enroll-link" class="w-full mt-4 btn-secondary">
                     Go to Main Site
                 </button>
            </form>
        </div>

        <div id="main-auth-page" class="theme-background">
            <div id="auth-landing-page" class="theme-card">
                <h1 class="text-3xl md:text-4xl font-semibold mb-8 text-gray-800 tracking-tight">Welcome</h1>
                <p class="text-gray-500 mb-10">Sign in to your account</p>
                <button id="login-nav-button" class="w-full btn-primary mb-4">Login</button>
                <button id="register-nav-button" class="w-full btn-secondary mb-4">Register</button>
            </div>

            <div id="login-container" class="theme-card hidden">
                <div class="flex items-center mb-6">
                    <button id="back-to-landing" class="text-gray-500 hover:text-gray-800 transition duration-200 mr-4 text-2xl font-bold">&larr;</button>
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700 mb-1">Welcome back!</h2>
                        <p class="text-gray-500 text-sm">Glad to see you, Again!</p>
                    </div>
                </div>

                <div class="flex space-x-4 mb-6">
                    <button id="faculty-tab" class="flex-1 px-4 py-2 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 transition duration-200">Faculty</button>
                    <button id="student-tab" class="flex-1 px-4 py-2 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200">Student</button>
                </div>

                <form id="faculty-login-form">
                    <div class="mb-4">
                        <label for="faculty-email" class="sr-only">Email</label>
                        <input type="email" id="faculty-email" required class="input-field" placeholder="Enter your email">
                    </div>
                    <div class="mb-2">
                        <label for="faculty-password" class="sr-only">Password</label>
                        <input type="password" id="faculty-password" required class="input-field" placeholder="Enter your password">
                    </div>
                    <div class="flex justify-end mb-6">
                        <a href="#" class="text-xs text-gray-500 hover:underline">Forgot Password?</a>
                    </div>
                    <button type="submit" class="w-full btn-primary">
                        Login
                    </button>
                </form>

                <form id="student-login-form" class="hidden">
                     <div class="mb-4">
                        <label for="student-email" class="sr-only">Email</label>
                        <input type="email" id="student-email" required class="input-field" placeholder="Enter your email">
                    </div>
                    <div class="mb-2">
                        <label for="student-password" class="sr-only">Password</label>
                        <input type="password" id="student-password" required class="input-field" placeholder="Enter your password">
                    </div>
                    <div class="flex justify-end mb-6">
                        <a href="#" class="text-xs text-gray-500 hover:underline">Forgot Password?</a>
                    </div>
                    <button type="submit" class="w-full btn-primary">
                        Login
                    </button>
                </form>

                <div class="mt-6 text-sm text-gray-500">
                    Don't have an account? <a href="#" id="show-register-button" class="font-semibold text-blue-600 hover:underline">Register Now</a>
                </div>
            </div>

            <div id="register-container" class="theme-card hidden">
                <div class="flex items-center mb-6">
                    <button id="back-to-landing-from-register" class="text-gray-500 hover:text-gray-800 transition duration-200 mr-4 text-2xl font-bold">&larr;</button>
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700 mb-1">Hello!</h2>
                        <p class="text-gray-500 text-sm">Register to get started</p>
                    </div>
                </div>

                <div class="flex space-x-4 mb-6">
                    <button id="new-faculty-tab" class="flex-1 px-4 py-2 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 transition duration-200">Faculty</button>
                    <button id="new-student-tab" class="flex-1 px-4 py-2 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200">Student</button>
                </div>

                <form id="faculty-create-form" class="mb-4">
                    <div class="mb-4">
                        <label for="new-faculty-name" class="sr-only">Full Name</label>
                        <input type="text" id="new-faculty-name" required class="input-field" placeholder="Full Name">
                    </div>
                    <div class="mb-4">
                        <label for="new-faculty-email" class="sr-only">Email</label>
                        <input type="email" id="new-faculty-email" required class="input-field" placeholder="Email">
                    </div>
                    <div class="mb-4">
                        <label for="new-faculty-password" class="sr-only">Password</label>
                        <input type="password" id="new-faculty-password" required class="input-field" placeholder="Password">
                    </div>
                    <button type="submit" class="w-full btn-primary">
                        Register
                    </button>
                </form>

                <form id="student-create-form" class="hidden mb-4">
                    <div class="mb-4">
                        <label for="new-student-name" class="sr-only">Full Name</label>
                        <input type="text" id="new-student-name" required class="input-field" placeholder="Full Name">
                    </div>
                    <div class="mb-4">
                        <label for="new-student-email" class="sr-only">Email</label>
                        <input type="email" id="new-student-email" required class="input-field" placeholder="Email">
                    </div>
                     <div class="mb-4">
                        <label for="new-student-roll" class="sr-only">Roll Number</label>
                        <input type="text" id="new-student-roll" required class="input-field" placeholder="Roll Number">
                    </div>
                    <div class="mb-4">
                        <label for="new-student-password" class="sr-only">Password</label>
                        <input type="password" id="new-student-password" required class="input-field" placeholder="Password">
                    </div>
                    <button type="submit" class="w-full btn-primary">
                        Register
                    </button>
                </form>

                <div class="mt-6 text-sm text-gray-500">
                    Already have an account? <a href="#" id="show-login-button" class="font-semibold text-blue-600 hover:underline">Login Now</a>
                </div>
            </div>
        </div>

        <div id="app-container" class="hidden">
            <div id="student-view" class="hidden">
                <div class="card md:w-2/3 lg:w-1/2 mx-auto">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Enroll in a Class</h2>
                    <form id="student-enroll-form">
                        <div class="mb-4">
                            <label for="student-enroll-name" class="block text-gray-700 font-medium mb-2">Full Name</label>
                            <input type="text" id="student-enroll-name" required class="input-field">
                        </div>
                        <div class="mb-4">
                            <label for="student-enroll-roll-number" class="block text-gray-700 font-medium mb-2">Roll Number</label>
                            <input type="text" id="student-enroll-roll-number" required class="input-field">
                        </div>
                        <div class="mb-4">
                            <label for="student-enroll-class-code" class="block text-gray-700 font-medium mb-2">Class Code/ID</label>
                            <input type="text" id="student-enroll-class-code" required class="input-field">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">Face Image</label>
                            <div class="flex space-x-2 mb-4">
                                <button type="button" id="student-enroll-webcam-tab-button" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Use Webcam</button>
                                <button type="button" id="student-enroll-upload-tab-button" class="flex-1 bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Upload Photo</button>
                            </div>
                            <div id="student-enroll-webcam-section">
                                <div id="student-enroll-webcam-container" class="relative">
                                    <video id="student-enroll-webcam-video" autoplay muted playsinline class="enrollment-webcam-video hidden"></video>
                                    <canvas id="student-enroll-webcam-canvas" class="hidden"></canvas>
                                </div>
                                <div class="flex space-x-2 mt-4">
                                    <button type="button" id="student-enroll-start-webcam-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Start Webcam</button>
                                    <button type="button" id="student-enroll-switch-camera-button" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Switch Camera</button>
                                    <button type="button" id="student-enroll-take-photo-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Take Photo</button>
                                </div>
                            </div>
                            <div id="student-enroll-upload-section" class="hidden">
                                <label for="student-enroll-image" class="block text-gray-700 font-medium mb-2">Upload Face Image</label>
                                <input type="file" id="student-enroll-image" accept="image/*" class="w-full text-gray-700">
                                <div id="student-enroll-image-preview-container" class="relative mt-4 hidden">
                                    <img id="student-enroll-image-preview" src="#" alt="Image Preview" class="max-w-full h-auto rounded-lg shadow-md">
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="student-enroll-button" class="mt-4 w-full btn-primary">
                            Enroll
                        </button>
                    </form>
                    <div class="flex justify-center mt-6">
                        <button id="logout-button-student" class="px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 font-medium">Logout</button>
                    </div>
                </div>
            </div>

            <div id="faculty-view" class="hidden">
                <div id="faculty-main-dashboard" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-700">Faculty Dashboard</h2>
                        <button id="logout-button-faculty-dash" class="btn-secondary">Logout</button>
                    </div>
                    <button id="add-class-button" class="mb-6 btn-primary">
                        Add Class
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 text-center col-span-full" id="no-classes-message">No classes created yet. Click 'Add Class' to create one.</p>
                        <ul id="class-list" class="col-span-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            </ul>
                    </div>
                </div>

                <div id="add-class-view" class="page hidden">
                    <div class="card md:w-2/3 lg:w-1/2 mx-auto">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6">Create a New Class</h2>
                        <form id="add-class-form">
                            <div class="mb-4">
                                <label for="new-class-name" class="block text-gray-700 font-medium mb-2">Class Name</label>
                                <input type="text" id="new-class-name" required class="input-field">
                            </div>
                            <button type="submit" class="w-full btn-primary">
                                Create Class
                            </button>
                            <button type="button" id="back-to-faculty-dashboard" class="w-full mt-4 btn-secondary">
                                Back to Dashboard
                            </button>
                        </form>
                        <div id="class-code-display" class="mt-8 pt-4 border-t-2 border-gray-200 hidden">
                            <h3 class="text-xl font-semibold text-green-700 mb-2">Class Created Successfully!</h3>
                            <p class="text-gray-600">Share this code with your students to enroll.</p>
                            <p class="text-2xl font-bold text-green-900 mt-2" id="generated-class-code"></p>
                        </div>
                    </div>
                </div>

                <div id="class-management-view" class="page hidden">
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-semibold text-gray-700" id="current-class-title"></h2>
                             <button id="back-to-main-dashboard" class="btn-secondary">
                                 &larr; Back
                             </button>
                        </div>
                        
                        <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-lg">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700">Shareable Code</h3>
                                <div class="flex items-center space-x-2 mt-2">
                                     <span id="class-share-code" class="text-xl font-bold text-blue-900"></span>
                                     <button id="copy-link-button" class="btn-secondary px-4 py-2">Copy</button>
                                </div>
                            </div>
                        </div>

                        <nav class="flex space-x-4 mb-8 border-b-2 border-gray-200">
                            <button id="nav-class-dashboard" class="px-4 py-3 rounded-t-lg text-gray-700 font-semibold border-b-2 border-transparent transition duration-200 hover:border-blue-600">Dashboard</button>
                            <button id="nav-class-enroll" class="px-4 py-3 rounded-t-lg text-gray-700 font-semibold border-b-2 border-transparent transition duration-200 hover:border-blue-600">Enroll Student</button>
                            <button id="nav-class-mark" class="px-4 py-3 rounded-t-lg text-gray-700 font-semibold border-b-2 border-transparent transition duration-200 hover:border-blue-600">Mark Attendance</button>
                        </nav>
    
                        <div id="class-page-dashboard" class="class-page">
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                                    <h3 class="text-lg font-semibold text-blue-800 mb-2">Total Students Enrolled</h3>
                                    <p id="class-dashboard-total-students" class="text-4xl font-bold text-blue-900">0</p>
                                </div>
                                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                                    <h3 class="text-lg font-semibold text-green-800 mb-2">Students Present Today</h3>
                                    <p id="class-dashboard-present-today" class="text-4xl font-bold text-green-900">0</p>
                                </div>
                                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                                    <h3 class="text-lg font-semibold text-yellow-800 mb-2">Last Attendance Check</h3>
                                    <p id="class-dashboard-last-check" class="text-xl font-bold text-yellow-900">N/A</p>
                                </div>
                            </div>
                            <div class="mt-8 pt-8 border-t-2 border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">Enrolled Students</h3>
                                <div id="class-student-list-container">
                                    <p class="text-gray-500 text-center" id="no-class-students-message">No students enrolled in this class yet.</p>
                                    <ul id="class-student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        </ul>
                                </div>
                            </div>
                        </div>
    
                        <div id="class-page-enroll" class="class-page hidden">
                            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Enroll a Student</h2>
                            <div class="md:w-2/3 lg:w-1/2 mx-auto">
                                <form id="enroll-form">
                                    <div class="mb-4">
                                        <label for="student-name" class="block text-gray-700 font-medium mb-2">Student Name</label>
                                        <input type="text" id="student-name" required class="input-field">
                                    </div>
                                    <div class="mb-4">
                                        <label for="roll-number" class="block text-gray-700 font-medium mb-2">Roll Number</label>
                                        <input type="text" id="roll-number" required class="input-field">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 font-medium mb-2">Face Image</label>
                                        <div class="flex space-x-2 mb-4">
                                            <button type="button" id="faculty-enroll-webcam-tab-button" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Use Webcam</button>
                                            <button type="button" id="faculty-enroll-upload-tab-button" class="flex-1 bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Upload Photo</button>
                                        </div>
                                        <div id="faculty-enroll-webcam-section">
                                            <div id="faculty-enroll-webcam-container" class="relative">
                                                <video id="faculty-enroll-webcam-video" autoplay muted playsinline class="enrollment-webcam-video hidden"></video>
                                                <canvas id="faculty-enroll-webcam-canvas" class="hidden"></canvas>
                                            </div>
                                            <div class="flex space-x-2 mt-4">
                                                <button type="button" id="faculty-enroll-start-webcam-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Start Webcam</button>
                                                <button type="button" id="faculty-enroll-switch-camera-button" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Switch Camera</button>
                                                <button type="button" id="faculty-enroll-take-photo-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Take Photo</button>
                                            </div>
                                        </div>
                                        <div id="faculty-enroll-upload-section" class="hidden">
                                            <label for="enroll-image" class="block text-gray-700 font-medium mb-2">Upload Face Image</label>
                                            <input type="file" id="enroll-image" accept="image/*" class="w-full text-gray-700">
                                            <div id="enroll-image-preview-container" class="relative mt-4 hidden">
                                                <img id="enroll-image-preview" src="#" alt="Image Preview" class="max-w-full h-auto rounded-lg shadow-md">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" id="enroll-button" class="mt-4 w-full btn-primary">
                                        Enroll Student
                                    </button>
                                </form>
                            </div>
                        </div>
    
                        <div id="class-page-mark" class="class-page hidden">
                            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Mark Attendance</h2>
                            <div class="md:w-2/3 lg:w-1/2 mx-auto">
                                
                                <div class="flex space-x-2 mb-4">
                                    <button id="webcam-tab-button" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Use Webcam</button>
                                    <button id="upload-tab-button" class="flex-1 bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200">Upload Photo</button>
                                </div>
    
                                <div id="webcam-section">
                                    <div id="attendance-photo-container" class="relative">
                                        <video id="webcam-video" autoplay muted playsinline class="rounded-lg shadow-md hidden"></video>
                                        <canvas id="attendance-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                                    </div>
                                    <div class="flex space-x-2 mt-4">
                                        <button id="start-webcam-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Start Webcam</button>
                                        <button id="switch-camera-button" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Switch Camera</button>
                                        <button id="take-photo-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Mark Attendance</button>
                                    </div>
                                </div>
    
                                <div id="upload-section" class="hidden">
                                    <form id="attendance-upload-form">
                                        <div class="mb-4">
                                            <label for="attendance-image" class="block text-gray-700 font-medium mb-2">Upload Group Photo</label>
                                            <input type="file" id="attendance-image" accept="image/*" required class="w-full text-gray-700">
                                        </div>
                                        <div id="uploaded-image-preview-container" class="relative mt-4 hidden">
                                            <img id="uploaded-image-preview" src="#" alt="Uploaded Image Preview" class="max-w-full h-auto rounded-lg shadow-md">
                                            <canvas id="uploaded-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                                        </div>
                                        <button type="submit" id="upload-mark-button" class="mt-4 w-full btn-primary">
                                            Mark Attendance
                                        </button>
                                    </form>
                                </div>
    
    
                                <div id="attendance-results" class="mt-8 pt-4 border-t-2 border-gray-200 hidden">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-xl font-semibold text-gray-700">Today's Present Students</h3>
                                        <button id="screenshot-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                            Take Screenshot
                                        </button>
                                    </div>
                                    <h4 id="detected-count" class="text-lg font-bold text-gray-800 mb-2">Faces Detected: 0</h4>
                                    <ul id="present-students-list" class="list-disc list-inside text-gray-600">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="card w-full max-w-sm mx-4 md:mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Edit Student Info</h3>
                <button type="button" id="close-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-roll-number-original">
                <div class="mb-4">
                    <label for="edit-student-name" class="block text-gray-700 font-medium mb-2">Student Name</label>
                    <input type="text" id="edit-student-name" required class="input-field">
                </div>
                <div class="mb-4">
                    <label for="edit-roll-number" class="block text-gray-700 font-medium mb-2">Roll Number</label>
                    <input type="text" id="edit-roll-number" required class="input-field">
                </div>
                <div class="mb-4">
                    <label for="edit-image" class="block text-gray-700 font-medium mb-2">Upload New Face Image (Optional)</label>
                    <input type="file" id="edit-image" accept="image/*" class="w-full text-gray-700">
                </div>
                <div id="edit-image-preview-container" class="relative mt-4 hidden">
                    <img id="edit-image-preview" src="#" alt="New Image Preview" class="max-w-full h-auto rounded-lg shadow-md">
                    <canvas id="edit-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                </div>

                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="cancel-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">Cancel</button>
                    <button type="submit" id="save-edit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <footer class="mt-8 py-6 text-center text-sm text-gray-500 border-t-2 border-gray-200">
        <p>&copy; 2025 Smart Attendance System. All rights reserved.</p>
        <p>
            An innovative concept by <strong>Om Doiphode</strong>.
            <br>
            Powered by modern web technologies and the powerful capabilities of Google's Firebase.
        </p>
    </footer>


    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCN2UNCt6ZkfDyDj41pQATgjGGpfvnsuQo",
            authDomain: "smartattendance-a4cf6.firebaseapp.com",
            projectId: "smartattendance-a4cf6",
            storageBucket: "smartattendance-a4cf6.firebasestorage.app",
            messagingSenderId: "124561541485",
            appId: "1:124561541485:web:18ba0745ca7fbe2ec33264",
            measurementId: "G-0RP9STN3J4"
        };

        // Initialize Firebase
        let db, auth;
        let currentUser = null;
        let userRole = null;
        const appContainer = document.getElementById('app-container');
        const loginContainer = document.getElementById('login-container');
        const statusPopup = document.getElementById('status-popup');
        const statusMessageEl = document.getElementById('status-message');
        const studentLogoutButton = document.getElementById('logout-button-student');
        const facultyLogoutButton = document.getElementById('logout-button-faculty-dash');
        const studentView = document.getElementById('student-view');
        const facultyView = document.getElementById('faculty-view');
        const studentEnrollmentLinkPage = document.getElementById('student-enrollment-link-page');
        
        // Login UI elements
        const mainAuthPage = document.getElementById('main-auth-page');
        const authLandingPage = document.getElementById('auth-landing-page');
        const loginNavButton = document.getElementById('login-nav-button');
        const registerNavButton = document.getElementById('register-nav-button');
        const registerContainer = document.getElementById('register-container');
        const backToLandingButton = document.getElementById('back-to-landing');
        const backToLandingFromRegisterButton = document.getElementById('back-to-landing-from-register');
        const showRegisterButton = document.getElementById('show-register-button');
        const showLoginButton = document.getElementById('show-login-button');

        const facultyTab = document.getElementById('faculty-tab');
        const studentTab = document.getElementById('student-tab');
        const facultyLoginForm = document.getElementById('faculty-login-form');
        const studentLoginForm = document.getElementById('student-login-form');
        const facultyCreateForm = document.getElementById('faculty-create-form');
        const studentCreateForm = document.getElementById('student-create-form');
        const facultyEmailLogin = document.getElementById('faculty-email');
        const facultyPasswordLogin = document.getElementById('faculty-password');
        const studentEmailLogin = document.getElementById('student-email');
        const studentPasswordLogin = document.getElementById('student-password');
        
        // New register UI elements
        const newFacultyTab = document.getElementById('new-faculty-tab');
        const newStudentTab = document.getElementById('new-student-tab');

        // Student enrollment via link elements
        const enrollmentClassNameEl = document.getElementById('enrollment-class-name');
        const enrollLinkForm = document.getElementById('enroll-link-form');
        const enrollLinkClassCodeInput = document.getElementById('enroll-link-class-code');
        const backToMainFromEnrollLinkBtn = document.getElementById('back-to-main-from-enroll-link');
        const enrollLinkWebcamTabButton = document.getElementById('enroll-link-webcam-tab-button');
        const enrollLinkUploadTabButton = document.getElementById('enroll-link-upload-tab-button');
        const enrollLinkWebcamSection = document.getElementById('enroll-link-webcam-section');
        const enrollLinkUploadSection = document.getElementById('enroll-link-upload-section');
        const enrollLinkWebcamVideo = document.getElementById('enroll-link-webcam-video');
        const enrollLinkWebcamCanvas = document.getElementById('enroll-link-webcam-canvas');
        const enrollLinkStartWebcamButton = document.getElementById('enroll-link-start-webcam-button');
        const enrollLinkSwitchCameraButton = document.getElementById('enroll-link-switch-camera-button');
        const enrollLinkTakePhotoButton = document.getElementById('enroll-link-take-photo-button');
        const enrollLinkImageInput = document.getElementById('enroll-link-image');
        const enrollLinkImagePreviewContainer = document.getElementById('enroll-link-image-preview-container');
        let isFrontEnrollmentLinkCamera = true;


        // Faculty Class Management Elements
        const facultyMainDashboard = document.getElementById('faculty-main-dashboard');
        const addClassButton = document.getElementById('add-class-button');
        const classListEl = document.getElementById('class-list');
        const noClassesMessage = document.getElementById('no-classes-message');
        const addClassView = document.getElementById('add-class-view');
        const addClassForm = document.getElementById('add-class-form');
        const backToFacultyDashboardBtn = document.getElementById('back-to-faculty-dashboard');
        const classCodeDisplay = document.getElementById('class-code-display');
        const generatedClassCodeEl = document.getElementById('generated-class-code');
        const classManagementView = document.getElementById('class-management-view');
        const currentClassTitle = document.getElementById('current-class-title');
        const backToMainDashboardBtn = document.getElementById('back-to-main-dashboard');
        const classDashboardNav = document.getElementById('nav-class-dashboard');
        const classEnrollNav = document.getElementById('nav-class-enroll');
        const classMarkNav = document.getElementById('nav-class-mark');
        const classPageDashboard = document.getElementById('class-page-dashboard');
        const classPageEnroll = document.getElementById('class-page-enroll');
        const classPageMark = document.getElementById('class-page-mark');
        const classDashboardTotalStudents = document.getElementById('class-dashboard-total-students');
        const classDashboardPresentToday = document.getElementById('class-dashboard-present-today');
        const classDashboardLastCheck = document.getElementById('class-dashboard-last-check');
        const classStudentListEl = document.getElementById('class-student-list');
        const noClassStudentsMessage = document.getElementById('no-class-students-message');
        const classShareCodeEl = document.getElementById('class-share-code');
        const copyLinkButton = document.getElementById('copy-link-button');


        let faceMatcher = null;
        let studentsCollection;
        let classesCollection;
        let currentClassId = null;

        // UI elements for Faculty Enroll section
        const enrollForm = document.getElementById('enroll-form');
        const facultyEnrollWebcamTabButton = document.getElementById('faculty-enroll-webcam-tab-button');
        const facultyEnrollUploadTabButton = document.getElementById('faculty-enroll-upload-tab-button');
        const facultyEnrollWebcamSection = document.getElementById('faculty-enroll-webcam-section');
        const facultyEnrollUploadSection = document.getElementById('faculty-enroll-upload-section');
        const facultyEnrollWebcamVideo = document.getElementById('faculty-enroll-webcam-video');
        const facultyEnrollWebcamCanvas = document.getElementById('faculty-enroll-webcam-canvas');
        const facultyEnrollStartWebcamButton = document.getElementById('faculty-enroll-start-webcam-button');
        const facultyEnrollSwitchCameraButton = document.getElementById('faculty-enroll-switch-camera-button');
        const facultyEnrollTakePhotoButton = document.getElementById('faculty-enroll-take-photo-button');
        const enrollImageInput = document.getElementById('enroll-image');
        const enrollImagePreview = document.getElementById('enroll-image-preview');
        const enrollImagePreviewContainer = document.getElementById('enroll-image-preview-container');
        const enrollCanvas = document.getElementById('enroll-canvas');
        let isFrontFacultyEnrollCamera = true;

        // Student-specific enrollment elements
        const studentEnrollForm = document.getElementById('student-enroll-form');
        const studentEnrollWebcamTabButton = document.getElementById('student-enroll-webcam-tab-button');
        const studentEnrollUploadTabButton = document.getElementById('student-enroll-upload-tab-button');
        const studentEnrollWebcamSection = document.getElementById('student-enroll-webcam-section');
        const studentEnrollUploadSection = document.getElementById('student-enroll-upload-section');
        const studentEnrollWebcamVideo = document.getElementById('student-enroll-webcam-video');
        const studentEnrollWebcamCanvas = document.getElementById('student-enroll-webcam-canvas');
        const studentEnrollStartWebcamButton = document.getElementById('student-enroll-start-webcam-button');
        const studentEnrollSwitchCameraButton = document.getElementById('student-enroll-switch-camera-button');
        const studentEnrollTakePhotoButton = document.getElementById('student-enroll-take-photo-button');
        const studentEnrollImageInput = document.getElementById('student-enroll-image');
        const studentEnrollImagePreview = document.getElementById('student-enroll-image-preview');
        const studentEnrollImagePreviewContainer = document.getElementById('student-enroll-image-preview-container');
        const studentEnrollCanvas = document.getElementById('student-enroll-canvas');
        let isFrontStudentEnrollCamera = true;


        // UI elements for Mark Attendance section
        const webcamTabButton = document.getElementById('webcam-tab-button');
        const uploadTabButton = document.getElementById('upload-tab-button');
        const webcamSection = document.getElementById('webcam-section');
        const uploadSection = document.getElementById('upload-section');
        const webcamVideo = document.getElementById('webcam-video');
        const startWebcamButton = document.getElementById('start-webcam-button');
        const switchCameraButton = document.getElementById('switch-camera-button');
        const takePhotoButton = document.getElementById('take-photo-button');
        const attendanceCanvas = document.getElementById('attendance-canvas');
        const attendanceUploadForm = document.getElementById('attendance-upload-form');
        const attendanceImageInput = document.getElementById('attendance-image');
        const uploadedImagePreview = document.getElementById('uploaded-image-preview');
        const uploadedImagePreviewContainer = document.getElementById('uploaded-image-preview-container');
        const uploadedCanvas = document.getElementById('uploaded-canvas');

        const attendanceResultsEl = document.getElementById('attendance-results');
        const detectedCountEl = document.getElementById('detected-count');
        const presentStudentsList = document.getElementById('present-students-list');
        const screenshotButton = document.getElementById('screenshot-button');

        let webcamStream = null;
        let detectionInterval = null;
        let isFrontCamera = true;

        // UI elements for the Edit Modal
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeBtn = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-edit');
        const editNameInput = document.getElementById('edit-student-name');
        const editRollInput = document.getElementById('edit-roll-number');
        const editOriginalRollInput = document.getElementById('edit-roll-number-original');
        const editImageInput = document.getElementById('edit-image');
        const editImagePreview = document.getElementById('edit-image-preview');
        const editImagePreviewContainer = document.getElementById('edit-image-preview-container');
        const editCanvas = document.getElementById('edit-canvas');

        const MIN_DISTANCE_THRESHOLD = 0.5;

        // Page navigation handler
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        function showClassPage(pageId) {
            document.querySelectorAll('.class-page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            document.querySelectorAll('#class-management-view nav button').forEach(button => button.classList.remove('border-blue-600', 'text-gray-700', 'bg-gray-200'));
            document.querySelectorAll('#class-management-view nav button').forEach(button => button.classList.add('text-gray-700'));
            
            const pageNavId = pageId.replace('class-page', 'nav-class');
            const navBtn = document.getElementById(pageNavId);
            navBtn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
            navBtn.classList.remove('text-gray-700');
        }
        
        // New Login Page functions
        function showAuthLandingPage() {
            authLandingPage.classList.remove('hidden');
            loginContainer.classList.add('hidden');
            registerContainer.classList.add('hidden');
        }

        function showLoginContainer() {
            authLandingPage.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            registerContainer.classList.add('hidden');
        }

        function showRegisterContainer() {
            authLandingPage.classList.add('hidden');
            loginContainer.classList.add('hidden');
            registerContainer.classList.remove('hidden');
        }

        // Helper function to show status messages
        function showStatus(message) {
            statusMessageEl.textContent = message;
            statusPopup.classList.remove('hidden');
        }
        
        function hideStatus() {
            statusPopup.classList.add('hidden');
        }

        // Load face-api.js models from local directory
        async function loadModels() {
            showStatus('Loading face detection models...');
            const modelsPath = './models/';
            await faceapi.nets.ssdMobilenetv1.loadFromUri(modelsPath);
            await faceapi.nets.faceLandmark68Net.loadFromUri(modelsPath);
            await faceapi.nets.faceRecognitionNet.loadFromUri(modelsPath);
            showStatus('Models loaded successfully.');
            setTimeout(hideStatus, 1000); 
        }
        
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Initialize the app after successful login
        async function initializeApp() {
            try {
                showStatus('Initializing Firebase...');
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                classesCollection = db.collection('classes');
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            userRole = userDoc.data().role;
                            if (userRole === 'faculty') {
                                facultyView.classList.remove('hidden');
                                studentView.classList.add('hidden');
                                await loadModels();
                                displayFacultyDashboard();
                            } else if (userRole === 'student') {
                                facultyView.classList.add('hidden');
                                studentView.classList.remove('hidden');
                                hideStatus();
                            }
                            mainAuthPage.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                        } else {
                            await auth.signOut();
                            showStatus('User data not found. Please log in again.');
                            setTimeout(hideStatus, 3000);
                        }
                    } else {
                        currentUser = null;
                        userRole = null;
                        appContainer.classList.add('hidden');
                        mainAuthPage.classList.remove('hidden');
                        showAuthLandingPage();
                        hideStatus();
                    }
                });
                
                // General Logout Listeners
                studentLogoutButton.addEventListener('click', async () => {
                    await auth.signOut();
                });
                facultyLogoutButton.addEventListener('click', async () => {
                    await auth.signOut();
                });

                // New login page navigation listeners
                loginNavButton.addEventListener('click', showLoginContainer);
                registerNavButton.addEventListener('click', showRegisterContainer);
                backToLandingButton.addEventListener('click', showAuthLandingPage);
                backToLandingFromRegisterButton.addEventListener('click', showAuthLandingPage);
                showRegisterButton.addEventListener('click', showRegisterContainer);
                showLoginButton.addEventListener('click', showLoginContainer);
                
                // Faculty-specific listeners
                addClassButton.addEventListener('click', () => {
                    showPage('add-class-view');
                });
                backToFacultyDashboardBtn.addEventListener('click', () => {
                    showPage('faculty-main-dashboard');
                });
                addClassForm.addEventListener('submit', handleAddClass);
                
                // Class-specific listeners
                backToMainDashboardBtn.addEventListener('click', () => {
                    showPage('faculty-main-dashboard');
                    displayFacultyDashboard();
                });
                classDashboardNav.addEventListener('click', () => {
                    showClassPage('class-page-dashboard');
                    displayClassDashboardData(currentClassId);
                });
                classEnrollNav.addEventListener('click', () => showClassPage('class-page-enroll'));
                classMarkNav.addEventListener('click', () => showClassPage('class-page-mark'));

                // Enrollment and Attendance listeners (now inside the class view)
                enrollForm.addEventListener('submit', handleEnroll);
                webcamTabButton.addEventListener('click', () => {
                    webcamSection.classList.remove('hidden');
                    uploadSection.classList.add('hidden');
                    webcamTabButton.classList.add('bg-gray-200');
                    webcamTabButton.classList.remove('bg-gray-50');
                    uploadTabButton.classList.remove('bg-gray-200');
                    uploadTabButton.classList.add('bg-gray-50');
                });
                uploadTabButton.addEventListener('click', () => {
                    uploadSection.classList.remove('hidden');
                    webcamSection.classList.add('hidden');
                    uploadTabButton.classList.add('bg-gray-200');
                    uploadTabButton.classList.remove('bg-gray-50');
                    webcamTabButton.classList.remove('bg-gray-200');
                    webcamTabButton.classList.add('bg-gray-50');
                    if (webcamStream) {
                        webcamStream.getTracks().forEach(track => track.stop());
                        webcamVideo.classList.add('hidden');
                        startWebcamButton.classList.remove('hidden');
                        takePhotoButton.classList.add('hidden');
                        switchCameraButton.classList.add('hidden');
                        clearInterval(detectionInterval);
                    }
                });
                startWebcamButton.addEventListener('click', startWebcam);
                switchCameraButton.addEventListener('click', () => {
                    isFrontCamera = !isFrontCamera;
                    startWebcam();
                });
                takePhotoButton.addEventListener('click', () => handleAttendance(webcamVideo));
                attendanceUploadForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const image = document.getElementById('uploaded-image-preview');
                    if(image.src) {
                        handleAttendance(image, uploadedCanvas);
                    } else {
                        showStatus('Please upload an image first.');
                        setTimeout(hideStatus, 3000);
                    }
                });
                attendanceImageInput.addEventListener('change', (e) => handleImagePreview(e, uploadedImagePreview, uploadedImagePreviewContainer));

                // Student enrollment via link listeners
                enrollLinkForm.addEventListener('submit', handleEnrollViaLink);
                backToMainFromEnrollLinkBtn.addEventListener('click', () => {
                    window.location.href = window.location.origin;
                });
                
                copyLinkButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(classShareCodeEl.textContent).then(() => {
                        showStatus('Code copied to clipboard!');
                        setTimeout(hideStatus, 3000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        showStatus('Failed to copy code.');
                        setTimeout(hideStatus, 3000);
                    });
                });
                
                // Faculty enrollment photo options
                facultyEnrollWebcamTabButton.addEventListener('click', () => {
                    facultyEnrollWebcamSection.classList.remove('hidden');
                    facultyEnrollUploadSection.classList.add('hidden');
                    facultyEnrollWebcamTabButton.classList.add('bg-gray-200');
                    facultyEnrollWebcamTabButton.classList.remove('bg-gray-50');
                    facultyEnrollUploadTabButton.classList.remove('bg-gray-200');
                    facultyEnrollUploadTabButton.classList.add('bg-gray-50');
                });
                facultyEnrollUploadTabButton.addEventListener('click', () => {
                    facultyEnrollUploadSection.classList.remove('hidden');
                    facultyEnrollWebcamSection.classList.add('hidden');
                    facultyEnrollUploadTabButton.classList.add('bg-gray-200');
                    facultyEnrollUploadTabButton.classList.remove('bg-gray-50');
                    facultyEnrollWebcamTabButton.classList.remove('bg-gray-200');
                    facultyEnrollWebcamTabButton.classList.add('bg-gray-50');
                    stopWebcamStream(facultyEnrollWebcamVideo);
                });
                facultyEnrollStartWebcamButton.addEventListener('click', () => startEnrollmentWebcam(facultyEnrollWebcamVideo, facultyEnrollStartWebcamButton, facultyEnrollTakePhotoButton, facultyEnrollSwitchCameraButton, isFrontFacultyEnrollCamera));
                facultyEnrollSwitchCameraButton.addEventListener('click', () => {
                    isFrontFacultyEnrollCamera = !isFrontFacultyEnrollCamera;
                    startEnrollmentWebcam(facultyEnrollWebcamVideo, facultyEnrollStartWebcamButton, facultyEnrollTakePhotoButton, facultyEnrollSwitchCameraButton, isFrontFacultyEnrollCamera);
                });
                facultyEnrollTakePhotoButton.addEventListener('click', () => takeEnrollmentPhoto(facultyEnrollWebcamVideo, enrollImageInput, facultyEnrollTakePhotoButton, facultyEnrollStartWebcamButton, facultyEnrollSwitchCameraButton));

                // Student enrollment photo options
                studentEnrollWebcamTabButton.addEventListener('click', () => {
                    studentEnrollWebcamSection.classList.remove('hidden');
                    studentEnrollUploadSection.classList.add('hidden');
                    studentEnrollWebcamTabButton.classList.add('bg-gray-200');
                    studentEnrollWebcamTabButton.classList.remove('bg-gray-50');
                    studentEnrollUploadTabButton.classList.remove('bg-gray-200');
                    studentEnrollUploadTabButton.classList.add('bg-gray-50');
                });
                studentEnrollUploadTabButton.addEventListener('click', () => {
                    studentEnrollUploadSection.classList.remove('hidden');
                    studentEnrollWebcamSection.classList.add('hidden');
                    studentEnrollUploadTabButton.classList.add('bg-gray-200');
                    studentEnrollUploadTabButton.classList.remove('bg-gray-50');
                    studentEnrollWebcamTabButton.classList.remove('bg-gray-200');
                    studentEnrollWebcamTabButton.classList.add('bg-gray-50');
                    stopWebcamStream(studentEnrollWebcamVideo);
                });
                studentEnrollStartWebcamButton.addEventListener('click', () => startEnrollmentWebcam(studentEnrollWebcamVideo, studentEnrollStartWebcamButton, studentEnrollTakePhotoButton, studentEnrollSwitchCameraButton, isFrontStudentEnrollCamera));
                studentEnrollSwitchCameraButton.addEventListener('click', () => {
                    isFrontStudentEnrollCamera = !isFrontStudentEnrollCamera;
                    startEnrollmentWebcam(studentEnrollWebcamVideo, studentEnrollStartWebcamButton, studentEnrollTakePhotoButton, studentEnrollSwitchCameraButton, isFrontStudentEnrollCamera);
                });
                studentEnrollTakePhotoButton.addEventListener('click', () => takeEnrollmentPhoto(studentEnrollWebcamVideo, studentEnrollImageInput, studentEnrollTakePhotoButton, studentEnrollStartWebcamButton, studentEnrollSwitchCameraButton));

                // Student enrollment via link photo options
                enrollLinkWebcamTabButton.addEventListener('click', () => {
                    enrollLinkWebcamSection.classList.remove('hidden');
                    enrollLinkUploadSection.classList.add('hidden');
                    enrollLinkWebcamTabButton.classList.add('bg-gray-200');
                    enrollLinkWebcamTabButton.classList.remove('bg-gray-50');
                    enrollLinkUploadTabButton.classList.remove('bg-gray-200');
                    enrollLinkUploadTabButton.classList.add('bg-gray-50');
                });
                enrollLinkUploadTabButton.addEventListener('click', () => {
                    enrollLinkUploadSection.classList.remove('hidden');
                    enrollLinkWebcamSection.classList.add('hidden');
                    enrollLinkUploadTabButton.classList.add('bg-gray-200');
                    enrollLinkUploadTabButton.classList.remove('bg-gray-50');
                    enrollLinkWebcamTabButton.classList.remove('bg-gray-200');
                    enrollLinkWebcamTabButton.classList.add('bg-gray-50');
                    stopWebcamStream(enrollLinkWebcamVideo);
                });
                enrollLinkStartWebcamButton.addEventListener('click', () => startEnrollmentWebcam(enrollLinkWebcamVideo, enrollLinkStartWebcamButton, enrollLinkTakePhotoButton, enrollLinkSwitchCameraButton, isFrontEnrollmentLinkCamera));
                enrollLinkSwitchCameraButton.addEventListener('click', () => {
                    isFrontEnrollmentLinkCamera = !isFrontEnrollmentLinkCamera;
                    startEnrollmentWebcam(enrollLinkWebcamVideo, enrollLinkStartWebcamButton, enrollLinkTakePhotoButton, enrollLinkSwitchCameraButton, isFrontEnrollmentLinkCamera);
                });
                enrollLinkTakePhotoButton.addEventListener('click', () => takeEnrollmentPhoto(enrollLinkWebcamVideo, enrollLinkImageInput, enrollLinkTakePhotoButton, enrollLinkStartWebcamButton, enrollLinkSwitchCameraButton));


                // New student-specific enrollment listener
                studentEnrollForm.addEventListener('submit', handleStudentEnroll);
                studentEnrollImageInput.addEventListener('change', (e) => handleImagePreview(e, studentEnrollImagePreview, studentEnrollImagePreviewContainer));

                // Edit Modal Listeners
                closeBtn.addEventListener('click', () => editModal.classList.add('hidden'));
                cancelBtn.addEventListener('click', () => editModal.classList.add('hidden'));
                editForm.addEventListener('submit', handleEditStudent);

            } catch (error) {
                showStatus(`Firebase initialization failed.`);
                console.error('Firebase initialization error:', error);
            }
        }

        // Handle login form submission
        facultyLoginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = facultyEmailLogin.value;
            const password = facultyPasswordLogin.value;

            try {
                showStatus('Logging in as faculty...');
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showStatus(`Login failed.`);
                setTimeout(hideStatus, 3000);
                console.error('Login error:', error);
            }
        });

        studentLoginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = studentEmailLogin.value;
            const password = studentPasswordLogin.value;

            try {
                showStatus('Logging in as student...');
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showStatus(`Login failed.`);
                setTimeout(hideStatus, 3000);
                console.error('Login error:', error);
            }
        });

        // Handle create account form submission
        facultyCreateForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('new-faculty-email').value;
            const password = document.getElementById('new-faculty-password').value;
            const name = document.getElementById('new-faculty-name').value;

            try {
                showStatus('Creating faculty account...');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    role: 'faculty'
                });
                showStatus('Faculty account created successfully!');
                setTimeout(hideStatus, 3000);
            } catch (error) {
                showStatus(`Account creation failed.`);
                setTimeout(hideStatus, 3000);
                console.error('Account creation error:', error);
            }
        });

        studentCreateForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('new-student-email').value;
            const password = document.getElementById('new-student-password').value;
            const name = document.getElementById('new-student-name').value;
            const rollNumber = document.getElementById('new-student-roll').value;

            try {
                showStatus('Creating student account...');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    rollNumber: rollNumber,
                    role: 'student'
                });
                showStatus('Student account created successfully!');
                setTimeout(hideStatus, 3000);
            } catch (error) {
                showStatus(`Account creation failed.`);
                setTimeout(hideStatus, 3000);
                console.error('Account creation error:', error);
            }
        });

        // Tab and form switching logic
        facultyTab.addEventListener('click', () => {
            facultyLoginForm.classList.remove('hidden');
            studentLoginForm.classList.add('hidden');
            facultyTab.classList.add('bg-blue-600', 'text-white');
            facultyTab.classList.remove('bg-gray-200', 'text-gray-700');
            studentTab.classList.remove('bg-blue-600', 'text-white');
            studentTab.classList.add('bg-gray-200', 'text-gray-700');
        });

        studentTab.addEventListener('click', () => {
            studentLoginForm.classList.remove('hidden');
            facultyLoginForm.classList.add('hidden');
            studentTab.classList.add('bg-blue-600', 'text-white');
            studentTab.classList.remove('bg-gray-200', 'text-gray-700');
            facultyTab.classList.remove('bg-blue-600', 'text-white');
            facultyTab.classList.add('bg-gray-200', 'text-gray-700');
        });

        newFacultyTab.addEventListener('click', () => {
            facultyCreateForm.classList.remove('hidden');
            studentCreateForm.classList.add('hidden');
            newFacultyTab.classList.add('bg-blue-600', 'text-white');
            newFacultyTab.classList.remove('bg-gray-200', 'text-gray-700');
            newStudentTab.classList.remove('bg-blue-600', 'text-white');
            newStudentTab.classList.add('bg-gray-200', 'text-gray-700');
        });

        newStudentTab.addEventListener('click', () => {
            studentCreateForm.classList.remove('hidden');
            facultyCreateForm.classList.add('hidden');
            newStudentTab.classList.add('bg-blue-600', 'text-white');
            newStudentTab.classList.remove('bg-gray-200', 'text-gray-700');
            newFacultyTab.classList.remove('bg-blue-600', 'text-white');
            newFacultyTab.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        // Faculty Class Management Functions
        async function displayFacultyDashboard() {
            showStatus('Fetching your classes...');
            const classesSnapshot = await classesCollection.where('facultyId', '==', currentUser.uid).get();
            classListEl.innerHTML = '';
            if (classesSnapshot.empty) {
                noClassesMessage.classList.remove('hidden');
            } else {
                noClassesMessage.classList.add('hidden');
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    const li = document.createElement('li');
                    li.classList.add('class-card');
                    li.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="font-semibold text-xl text-blue-800">${classData.className}</h3>
                            <p class="text-sm text-blue-600 mt-1">Code: ${classData.classCode}</p>
                        </div>
                        <div class="flex mt-4 space-x-2">
                            <button class="btn-primary text-sm px-4 py-2" onclick="openClassView('${doc.id}', '${classData.className}')">
                                Open
                            </button>
                            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm" onclick="handleRemoveClass('${doc.id}')">
                                Remove
                            </button>
                        </div>
                    `;
                    classListEl.appendChild(li);
                });
                showStatus('Classes loaded successfully.');
                setTimeout(hideStatus, 3000);
            }
        }

        async function handleRemoveClass(classId) {
            if (confirm("Are you sure you want to remove this class and all its students? This cannot be undone.")) {
                showStatus(`Removing class with ID ${classId}...`);
                try {
                    const studentsSnapshot = await classesCollection.doc(classId).collection('students').get();
                    const batch = db.batch();
                    studentsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    await classesCollection.doc(classId).delete();
                    showStatus('Class and all its students removed successfully.');
                    setTimeout(hideStatus, 3000);
                    await displayFacultyDashboard();
                } catch (error) {
                    showStatus(`Failed to remove class.`);
                    setTimeout(hideStatus, 3000);
                    console.error('Removal error:', error);
                }
            }
        }
        
        async function handleAddClass(event) {
            event.preventDefault();
            const className = document.getElementById('new-class-name').value;
            const classCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            showStatus('Creating class...');
            try {
                await classesCollection.doc(classCode).set({
                    className: className,
                    classCode: classCode,
                    facultyId: currentUser.uid
                });
                generatedClassCodeEl.textContent = classCode;
                classCodeDisplay.classList.remove('hidden');
                showStatus('Class created successfully! You can find the code above.');
                setTimeout(hideStatus, 3000);
                addClassForm.reset();
                displayFacultyDashboard(); 
            } catch (error) {
                showStatus(`Failed to create class.`);
                setTimeout(hideStatus, 3000);
                console.error('Class creation error:', error);
            }
        }
        
        async function openClassView(classId, className) {
             currentClassId = classId;
             currentClassTitle.textContent = className;
             classShareCodeEl.textContent = classId;
             showPage('class-management-view');
             showClassPage('class-page-dashboard');
             await updateFaceMatcher(classId);
             displayClassDashboardData(classId);
        }

        async function displayClassDashboardData(classId) {
            const studentsInClassCollection = db.collection('classes').doc(classId).collection('students');
            const studentsSnapshot = await studentsInClassCollection.get();
            const totalStudents = studentsSnapshot.size;
            classDashboardTotalStudents.textContent = totalStudents;
            
            const today = new Date().toISOString().slice(0, 10);
            let presentTodayCount = 0;
            
            studentsSnapshot.forEach(doc => {
                const student = doc.data();
                if (student.attendanceHistory && student.attendanceHistory.includes(today)) {
                    presentTodayCount++;
                }
            });
            classDashboardPresentToday.textContent = presentTodayCount;
            
            const lastCheck = localStorage.getItem('lastAttendanceCheck-' + classId);
            if (lastCheck) {
                classDashboardLastCheck.textContent = lastCheck;
            } else {
                classDashboardLastCheck.textContent = 'N/A';
            }

            await displayClassStudentList(classId);
        }

        async function displayClassStudentList(classId) {
            const studentsInClassCollection = db.collection('classes').doc(classId).collection('students');
            const studentsSnapshot = await studentsInClassCollection.get();
            classStudentListEl.innerHTML = '';
            if (studentsSnapshot.empty) {
                noClassStudentsMessage.classList.remove('hidden');
            } else {
                noClassStudentsMessage.classList.add('hidden');
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const attendanceCount = student.attendanceHistory ? student.attendanceHistory.length : 0;
                    const li = document.createElement('li');
                    li.classList.add('flex', 'flex-col', 'md:flex-row', 'items-center', 'justify-between', 'bg-gray-50', 'p-4', 'rounded-lg', 'shadow-sm', 'cursor-pointer', 'transition', 'duration-200', 'hover:bg-gray-100');
                    li.innerHTML = `
                        <div class="flex-1 text-center md:text-left mb-2 md:mb-0">
                            <p class="font-semibold text-gray-800">${student.name}</p>
                            <p class="text-gray-600 text-sm">Roll: ${student.rollNumber} • Attendance: ${attendanceCount}</p>
                        </div>
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200" onclick="event.stopPropagation(); handleRemoveStudent('${student.rollNumber}', '${classId}')">
                            Remove
                        </button>
                    `;
                    li.addEventListener('click', () => openEditModal(student));
                    classStudentListEl.appendChild(li);
                });
            }
        }
        
        // Handle student enrollment via link
        async function handleEnrollViaLink(event) {
            event.preventDefault();
            const classCode = document.getElementById('enroll-link-class-code').value;
            const name = document.getElementById('enroll-link-student-name').value;
            const rollNumber = document.getElementById('enroll-link-roll-number').value;
            const imageInput = document.getElementById('enroll-link-image');
            
            const file = imageInput.files[0];
            if (!file) {
                showStatus('Please upload or take a photo.');
                setTimeout(hideStatus, 3000);
                return;
            }
            
            const image = new Image();
            const reader = new FileReader();
            reader.readAsDataURL(file);
            await new Promise(resolve => reader.onload = () => {
                image.src = reader.result;
                resolve();
            });
            
            showStatus('Processing image and enrolling...');
            
            try {
                const descriptor = await getFaceDescriptor(image);
                if (!descriptor) {
                    showStatus('No face detected. Please upload a clearer photo.');
                    setTimeout(hideStatus, 3000);
                    return;
                }
                
                const studentsInClassCollection = db.collection('classes').doc(classCode).collection('students');
                await studentsInClassCollection.doc(rollNumber).set({
                    name: name,
                    rollNumber: rollNumber,
                    descriptor: Array.from(descriptor),
                    attendanceHistory: []
                });
                
                showStatus(`Successfully enrolled in the class!`);
                setTimeout(hideStatus, 3000);
                enrollLinkForm.reset();
            } catch (error) {
                showStatus(`Failed to enroll.`);
                setTimeout(hideStatus, 3000);
                console.error('Enrollment error:', error);
            }
        }
        
        // Handle student enrollment from the student's dashboard
        async function handleStudentEnroll(event) {
            event.preventDefault();
            const name = document.getElementById('student-enroll-name').value;
            const rollNumber = document.getElementById('student-enroll-roll-number').value;
            const classCode = document.getElementById('student-enroll-class-code').value;
            const imageInput = document.getElementById('student-enroll-image');

            const file = imageInput.files[0];
            if (!file) {
                showStatus('Please upload or take a photo.');
                setTimeout(hideStatus, 3000);
                return;
            }

            const image = new Image();
            const reader = new FileReader();
            reader.readAsDataURL(file);
            await new Promise(resolve => reader.onload = () => {
                image.src = reader.result;
                resolve();
            });

            showStatus('Processing image and extracting face descriptor...');
            const descriptor = await getFaceDescriptor(image);

            if (!descriptor) {
                showStatus('No face detected. Please upload a clearer photo.');
                setTimeout(hideStatus, 3000);
                return;
            }

            try {
                const studentsInClassCollection = db.collection('classes').doc(classCode).collection('students');
                
                // Check if the class code is valid
                const classDoc = await db.collection('classes').doc(classCode).get();
                if (!classDoc.exists) {
                    showStatus('Invalid Class Code. Please try again.');
                    setTimeout(hideStatus, 3000);
                    return;
                }

                showStatus('Saving student data to Firestore...');
                await studentsInClassCollection.doc(rollNumber).set({
                    name: name,
                    rollNumber: rollNumber,
                    descriptor: Array.from(descriptor),
                    attendanceHistory: []
                });
                showStatus(`Student ${name} (Roll: ${rollNumber}) enrolled successfully in class ${classCode}!`);
                setTimeout(hideStatus, 3000);
                studentEnrollForm.reset();
                studentEnrollImagePreviewContainer.classList.add('hidden');
            } catch (error) {
                showStatus(`Failed to enroll student.`);
                setTimeout(hideStatus, 3000);
                console.error('Enrollment error:', error);
            }
        }

        // Handle image preview
        function handleImagePreview(event, imgElement, container) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgElement.src = e.target.result;
                    container.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imgElement.src = '#';
                container.classList.add('hidden');
            }
        }

        // Get face descriptor from an image
        async function getFaceDescriptor(image) {
            const detections = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
            return detections ? detections.descriptor : null;
        }

        // Handle student enrollment (now class-specific)
        async function handleEnroll(event) {
            event.preventDefault();
            const name = document.getElementById('student-name').value;
            const rollNumber = document.getElementById('roll-number').value;
            const imageInput = document.getElementById('enroll-image');

            const file = imageInput.files[0];
            if (!file) {
                showStatus('Please upload or take a photo.');
                setTimeout(hideStatus, 3000);
                return;
            }

            const image = new Image();
            const reader = new FileReader();
            reader.readAsDataURL(file);
            await new Promise(resolve => reader.onload = () => {
                image.src = reader.result;
                resolve();
            });

            showStatus('Processing image and extracting face descriptor...');
            const descriptor = await getFaceDescriptor(image);

            if (!descriptor) {
                showStatus('No face detected. Please upload a clearer photo.');
                setTimeout(hideStatus, 3000);
                return;
            }

            try {
                showStatus('Saving student data to Firestore...');
                await new Promise(r => setTimeout(r, 1000)); // Simulate a delay
                const studentsInClassCollection = db.collection('classes').doc(currentClassId).collection('students');
                await studentsInClassCollection.doc(rollNumber).set({
                    name: name,
                    rollNumber: rollNumber,
                    descriptor: Array.from(descriptor),
                    attendanceHistory: []
                });
                showStatus(`Student ${name} (Roll: ${rollNumber}) enrolled successfully!`);
                setTimeout(hideStatus, 3000);
                await updateFaceMatcher(currentClassId);
                await displayClassDashboardData(currentClassId);
                enrollForm.reset();
                enrollImagePreviewContainer.classList.add('hidden');
                showClassPage('class-page-dashboard');
            } catch (error) {
                showStatus(`Failed to enroll student.`);
                setTimeout(hideStatus, 3000);
                console.error('Enrollment error:', error);
            }
        }

        // Open the edit modal with student info
        function openEditModal(studentData) {
            editNameInput.value = studentData.name;
            editRollInput.value = studentData.rollNumber;
            editOriginalRollInput.value = studentData.rollNumber;
            editImageInput.value = '';
            editImagePreview.src = '#';
            editImagePreviewContainer.classList.add('hidden');
            editModal.classList.remove('hidden');
        }

        // Handle editing student info (now class-specific)
        async function handleEditStudent(event) {
            event.preventDefault();
            const newName = editNameInput.value;
            const newRollNumber = editRollInput.value;
            const originalRollNumber = editOriginalRollInput.value;
            const newImageFile = editImageInput.files[0];
        
            if (newName === '' || newRollNumber === '') {
                showStatus('Name and Roll Number cannot be empty.');
                setTimeout(hideStatus, 3000);
                return;
            }
        
            showStatus('Updating student information...');
        
            try {
                let updatedData = {
                    name: newName
                };
                let newDescriptor = null;
        
                if (newImageFile) {
                    const img = new Image();
                    img.src = URL.createObjectURL(newImageFile);
                    await new Promise(resolve => img.onload = resolve);
                    newDescriptor = await getFaceDescriptor(img);
                    URL.revokeObjectURL(img.src);
        
                    if (!newDescriptor) {
                        showStatus('No face detected in the new image. Please upload a clearer photo or try again.');
                        setTimeout(hideStatus, 3000);
                        return;
                    }
                    updatedData.descriptor = Array.from(newDescriptor);
                }
                
                const studentsInClassCollection = db.collection('classes').doc(currentClassId).collection('students');
                const studentDocRef = studentsInClassCollection.doc(originalRollNumber);
        
                if (newRollNumber !== originalRollNumber) {
                    const studentData = (await studentDocRef.get()).data();
                    if (studentData) {
                        // Check for existing roll number to avoid overwrite
                        const existingRollDoc = await studentsInClassCollection.doc(newRollNumber).get();
                        if (existingRollDoc.exists) {
                            showStatus(`A student with roll number ${newRollNumber} already exists.`);
                            setTimeout(hideStatus, 3000);
                            return;
                        }

                        // Use a transaction for atomic update and delete
                        await db.runTransaction(async (transaction) => {
                            const newDocRef = studentsInClassCollection.doc(newRollNumber);
                            transaction.set(newDocRef, {
                                ...studentData,
                                ...updatedData,
                                rollNumber: newRollNumber 
                            });
                            transaction.delete(studentDocRef);
                        });
                    }
                } else {
                    await studentDocRef.update(updatedData);
                }
        
                showStatus('Student information updated successfully!');
                setTimeout(hideStatus, 3000);
                editModal.classList.add('hidden');
                editImageInput.value = '';
                editImagePreview.src = '#';
                editImagePreviewContainer.classList.add('hidden');
        
                await updateFaceMatcher(currentClassId);
                await displayClassDashboardData(currentClassId);
            } catch (error) {
                showStatus(`Failed to update student.`);
                setTimeout(hideStatus, 3000);
                console.error('Update error:', error);
            }
        }
        

        // Function to delete a student from the database (now class-specific)
        async function handleRemoveStudent(rollNumber, classId) {
            if (confirm(`Are you sure you want to remove student with roll number ${rollNumber}?`)) {
                showStatus(`Removing student with roll number ${rollNumber}...`);
                try {
                    const studentsInClassCollection = db.collection('classes').doc(classId).collection('students');
                    await studentsInClassCollection.doc(rollNumber).delete();
                    showStatus(`Student with roll number ${rollNumber} removed successfully.`);
                    setTimeout(hideStatus, 3000);
                    await updateFaceMatcher(classId);
                    await displayClassDashboardData(classId);
                } catch (error) {
                    showStatus(`Failed to remove student.`);
                    setTimeout(hideStatus, 3000);
                    console.error('Removal error:', error);
                }
            }
        }

        // Build a new FaceMatcher from the database (now class-specific)
        async function updateFaceMatcher(classId) {
            showStatus('Updating student database for attendance...');
            const studentsInClassCollection = db.collection('classes').doc(classId).collection('students');
            const studentsSnapshot = await studentsInClassCollection.get();
            const labeledDescriptors = studentsSnapshot.docs.map(doc => {
                const data = doc.data();
                const descriptor = new Float32Array(data.descriptor);
                return new faceapi.LabeledFaceDescriptors(data.name, [descriptor]);
            });

            if (labeledDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MIN_DISTANCE_THRESHOLD);
                showStatus('Database updated. Ready for attendance.');
                setTimeout(hideStatus, 3000);
            } else {
                faceMatcher = null;
                showStatus('No students enrolled yet. Please enroll a student first.');
                setTimeout(hideStatus, 3000);
            }
        }

        // General webcam start function for enrollment and attendance
        let activeWebcamStream = null;
        async function startEnrollmentWebcam(videoElement, startButton, takePhotoButton, switchButton, isFront) {
            try {
                stopWebcamStream(videoElement);
                const constraints = { video: { facingMode: isFront ? 'user' : 'environment' } };
                activeWebcamStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = activeWebcamStream;
                videoElement.classList.remove('hidden');
                startButton.classList.add('hidden');
                takePhotoButton.classList.remove('hidden');
                switchButton.classList.remove('hidden');
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                showStatus('Could not access the webcam.');
                setTimeout(hideStatus, 3000);
                switchButton.classList.add('hidden');
            }
        }

        function stopWebcamStream(videoElement) {
            if (activeWebcamStream) {
                activeWebcamStream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                activeWebcamStream = null;
            }
        }

        function takeEnrollmentPhoto(videoElement, fileInput, takePhotoButton, startButton, switchButton) {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => {
                const file = new File([blob], 'enrollment_photo.png', { type: 'image/png' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
                stopWebcamStream(videoElement);
                takePhotoButton.classList.add('hidden');
                startButton.classList.remove('hidden');
                switchButton.classList.add('hidden');
            }, 'image/png');
        }


        // Start the webcam stream and live detection
        async function startWebcam() {
            try {
                if (webcamStream) {
                    webcamStream.getTracks().forEach(track => track.stop());
                }
        
                const constraints = {
                    video: {
                        facingMode: isFrontCamera ? 'user' : 'environment'
                    }
                };
        
                webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
                webcamVideo.srcObject = webcamStream;
                webcamVideo.classList.remove('hidden');
                uploadedImagePreviewContainer.classList.add('hidden');
                attendanceCanvas.classList.remove('hidden');
                startWebcamButton.classList.remove('hidden');
                takePhotoButton.classList.remove('hidden');
                switchCameraButton.classList.remove('hidden');
        
                webcamVideo.onloadeddata = () => {
                    attendanceCanvas.width = webcamVideo.videoWidth;
                    attendanceCanvas.height = webcamVideo.videoHeight;
                    const displaySize = { width: webcamVideo.videoWidth, height: webcamVideo.videoHeight };
                    faceapi.matchDimensions(attendanceCanvas, displaySize);
        
                    if (detectionInterval) {
                        clearInterval(detectionInterval);
                    }
                    detectionInterval = setInterval(async () => {
                        const detections = await faceapi.detectAllFaces(webcamVideo).withFaceLandmarks();
                        const resizedDetections = faceapi.resizeResults(detections, displaySize);
                        attendanceCanvas.getContext('2d').clearRect(0, 0, attendanceCanvas.width, attendanceCanvas.height);
                        resizedDetections.forEach(detection => {
                            const drawBox = new faceapi.draw.DrawBox(detection.detection.box, { label: 'Face' });
                            drawBox.draw(attendanceCanvas);
                        });
                    }, 100);
                };
        
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                showStatus('Could not access the webcam.');
                setTimeout(hideStatus, 3000);
                switchCameraButton.classList.add('hidden');
            }
        }

        // Handle attendance marking (now class-specific)
        async function handleAttendance(imageSource, canvasSource = attendanceCanvas) {

            if (!faceMatcher) {
                showStatus('No students enrolled. Please enroll a student first.');
                setTimeout(hideStatus, 3000);
                return;
            }

            if (webcamStream) {
                clearInterval(detectionInterval);
                webcamStream.getTracks().forEach(track => track.stop());
                webcamVideo.classList.add('hidden');
                startWebcamButton.classList.remove('hidden');
                takePhotoButton.classList.add('hidden');
                switchCameraButton.classList.add('hidden');
            }

            // Resetting the count
            detectedCountEl.textContent = 'Faces Detected: 0';
            showStatus('Processing photo and matching faces...');

            let imageToProcess;
            let canvasToDraw;

            if (imageSource instanceof HTMLVideoElement) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = imageSource.videoWidth;
                tempCanvas.height = imageSource.videoHeight;
                tempCanvas.getContext('2d').drawImage(imageSource, 0, 0, tempCanvas.width, tempCanvas.height);
                imageToProcess = tempCanvas;
                canvasToDraw = attendanceCanvas;
            } else {
                imageToProcess = imageSource;
                canvasToDraw = canvasSource;
            }


            const detections = await faceapi.detectAllFaces(imageToProcess).withFaceLandmarks().withFaceDescriptors();

            // Updating the count
            detectedCountEl.textContent = `Faces Detected: ${detections.length}`;

            if (detections.length === 0) {
                showStatus('No faces detected in the photo. Please take a different photo.');
                setTimeout(hideStatus, 3000);
                return;
            }

            showStatus(`Detected ${detections.length} faces. Marking attendance...`);

            const presentStudents = new Set();
            const displaySize = { width: imageToProcess.naturalWidth || imageToProcess.width, height: imageToProcess.naturalHeight || imageToProcess.height };
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            const context = canvasToDraw.getContext('2d');
            context.clearRect(0, 0, canvasToDraw.width, canvasToDraw.height);
            faceapi.matchDimensions(canvasToDraw, displaySize);

            resizedDetections.forEach(detection => {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                const box = detection.detection.box;

                if (bestMatch.distance < MIN_DISTANCE_THRESHOLD) {
                    const studentName = bestMatch.label;
                    presentStudents.add(studentName);

                    const drawBox = new faceapi.draw.DrawBox(box, { label: `${studentName}` });
                    drawBox.draw(canvasToDraw);
                } else {
                    const drawBox = new faceapi.draw.DrawBox(box, { label: 'Unknown' });
                    drawBox.draw(canvasToDraw);
                }
            });

            const today = new Date().toISOString().slice(0, 10);
            const studentsInClassCollection = db.collection('classes').doc(currentClassId).collection('students');
            for (const name of presentStudents) {
                const studentDoc = await studentsInClassCollection.where('name', '==', name).limit(1).get();
                if (!studentDoc.empty) {
                    const doc = studentDoc.docs[0];
                    const currentHistory = doc.data().attendanceHistory || [];
                    if (!currentHistory.includes(today)) {
                        currentHistory.push(today);
                        await doc.ref.update({ attendanceHistory: currentHistory });
                    }
                }
            }

            presentStudentsList.innerHTML = '';
            if (presentStudents.size > 0) {
                showStatus(`Attendance marked! ${presentStudents.size} students identified.`);
                setTimeout(hideStatus, 3000);
                presentStudents.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    presentStudentsList.appendChild(li);
                });
            } else {
                showStatus('No matching students found in the photo.');
                setTimeout(hideStatus, 3000);
                const li = document.createElement('li');
                li.textContent = 'No students identified.';
                presentStudentsList.appendChild(li);
            }
            attendanceResultsEl.classList.remove('hidden');

            localStorage.setItem('lastAttendanceCheck-' + currentClassId, new Date().toLocaleString());
            await displayClassDashboardData(currentClassId);
        }

        // Handle screenshot functionality
        function handleScreenshot() {
            const attendanceContainer = document.getElementById('attendance-results');
            html2canvas(attendanceContainer).then(canvas => {
                const link = document.createElement('a');
                link.download = `attendance-report-${new Date().toISOString().slice(0, 10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // Initial app load logic
        document.addEventListener('DOMContentLoaded', async () => {
            initializeApp();
        });
    </script>
</body>
</html>




